---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: {{ .Values.app.name }}-argocd-task
  namespace: {{ .Release.Namespace }}
  labels:
    backstage.io/kubernetes-id: {{ .Values.app.name }}
    app.kubernetes.io/part-of: {{ .Values.app.name }}
spec:
  params:
    - name: appName
      description: ArgoCD application name (e.g., myapp-staging or myapp-prod)
      type: string
    - name: image-tag
      description: The image tag to update in the Values file
      type: string
    - name: environment
      description: Target environment (staging or prod)
      type: string
      default: staging
  steps:
    # Step 1: Clone gitops repo and update the image tag
    - name: update-gitops
      image: 'alpine/git:latest'
      env:
        - name: GIT_TOKEN
          valueFrom:
            secretKeyRef:
              name: {{ .Values.sealedSecrets.git.secretName }}
              key: token
        - name: GIT_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Values.sealedSecrets.git.secretName }}
              key: username
      script: |
        #!/bin/sh
        set -e
        
        echo "=== Configuring Git ==="
        git config --global user.email "tekton@backstage.io"
        git config --global user.name "Tekton Pipeline"
        
        echo "=== Cloning GitOps Repository ==="
        git clone https://${GIT_USERNAME}:${GIT_TOKEN}@{{ .Values.git.host }}/{{ .Values.git.org }}/{{ .Values.app.name }}-gitops.git
        cd {{ .Values.app.name }}-gitops
        
        # Determine values file based on environment
        ENVIRON=$(params.environment)
        if [ "$ENVIRON" = "staging" ]; then
          FILE="Values-staging.yaml"
        else
          FILE="Values-prod.yaml"
        fi
        
        echo "=== Updating $FILE with image tag: $(params.image-tag) ==="
        
        # Update the image tag in the values file using yq (more robust than sed)
        # Fallback to sed if yq is not available
        if command -v yq &> /dev/null; then
          yq -i '.image.tag = "$(params.image-tag)"' helm/app/$FILE
        else
          # Using sed as fallback - update the tag line under image section
          sed -i "s/^  tag:.*/  tag: $(params.image-tag)/" helm/app/$FILE
        fi
        
        echo "=== Updated Values File ==="
        cat helm/app/$FILE
        
        echo "=== Committing Changes ==="
        git add .
        git commit -m "ðŸš€ Promote to $ENVIRON: image tag $(params.image-tag)" || echo "No changes to commit"
        git push
        
        echo "=== GitOps Update Complete ==="

    # Step 2: Sync ArgoCD application (skip for prod - requires manual approval)
    - name: argocd-sync
      image: 'quay.io/redhat-gpte/argocd-cli:v2.8.4'
      env:
        - name: ARGOCD_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.sealedSecrets.argocd.secretName }}
              key: password
        - name: ARGOCD_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Values.sealedSecrets.argocd.secretName }}
              key: username
              optional: true
      script: |
        #!/bin/sh
        set -e
        
        ENVIRON=$(params.environment)
        ARGOCD_USER=${ARGOCD_USERNAME:-admin}
        ARGOCD_SERVER="{{ .Values.argocd.server }}"
        
        echo "=== Logging into ArgoCD ==="
        argocd login --grpc-web \
           --skip-test-tls --insecure \
          --username $ARGOCD_USER \
          --password $ARGOCD_PASSWORD \
          $ARGOCD_SERVER
        
        # For PROD: Skip auto-sync, require manual approval (demo gate)
        if [ "$ENVIRON" = "prod" ]; then
          echo "=============================================="
          echo "ðŸš¨ PRODUCTION DEPLOYMENT REQUIRES MANUAL APPROVAL"
          echo "=============================================="
          echo ""
          echo "GitOps repository has been updated with image tag: $(params.image-tag)"
          echo ""
          echo "To deploy to production, manually sync in ArgoCD:"
          echo "  argocd app sync $(params.appName)"
          echo ""
          echo "Or use the ArgoCD UI to approve the deployment."
          echo ""
          argocd app get $(params.appName)
          exit 0
        fi
        
        echo "=== Syncing Application: $(params.appName) ==="
        argocd app sync $(params.appName) --prune
        
        echo "=== Waiting for Sync to Complete ==="
        argocd app wait $(params.appName) --health --timeout 300
        
        echo "=== Sync Complete ==="
        argocd app get $(params.appName)

