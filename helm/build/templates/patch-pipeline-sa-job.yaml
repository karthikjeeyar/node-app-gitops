{{- if or .Values.sealedSecrets.git.enabled .Values.sealedSecrets.registry.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.app.name }}-patch-pipeline-sa
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-weight: "5"
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      # Use dedicated ServiceAccount with permissions to patch ServiceAccounts
      serviceAccountName: {{ .Values.app.name }}-patch-sa
      restartPolicy: Never
      containers:
      - name: patch-serviceaccount
        image: quay.io/openshift/origin-cli:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Linking secrets to pipeline ServiceAccount in namespace {{ .Release.Namespace }}..."
          
          # Link git secret if configured
          {{- if .Values.sealedSecrets.git.enabled }}
          echo "Linking git secret: {{ .Values.sealedSecrets.git.secretName }}"
          oc secrets link pipeline {{ .Values.sealedSecrets.git.secretName }} --for=mount -n {{ .Release.Namespace }} || echo "Secret {{ .Values.sealedSecrets.git.secretName }} may already be linked"
          {{- end }}
          
          # Link registry secret for both pull and mount if enabled
          {{- if .Values.sealedSecrets.registry.enabled }}
          echo "Linking registry secret: {{ .Values.sealedSecrets.registry.secretName }}"
          oc secrets link pipeline {{ .Values.sealedSecrets.registry.secretName }} --for=pull,mount -n {{ .Release.Namespace }} || echo "Secret {{ .Values.sealedSecrets.registry.secretName }} may already be linked"
          {{- end }}
          
          echo "ServiceAccount secrets linked successfully"
{{- end }}

